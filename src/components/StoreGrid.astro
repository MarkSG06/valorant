---
import SkinCard from './SkinCard.astro';

const dailySkins = [
	{
		name: 'Reaver Vandal',
		price: 1775,
		rarity: 'Premium',
		image: 'https://media.valorant-api.com/weaponskinlevels/06eb248e-4a6f-6c17-6401-4ebb66c72956/displayicon.png'
	},
	{
		name: 'Prime Phantom',
		price: 1775,
		rarity: 'Premium',
		image: 'https://media.valorant-api.com/weaponskinlevels/9fcbc9e0-4767-f4ad-9817-48a0443d3b6f/displayicon.png'
	},
	{
		name: 'Elderflame Operator',
		price: 2475,
		rarity: 'Ultra',
		image: 'https://media.valorant-api.com/weaponskinlevels/0fdf6e72-4f10-d096-7d1c-ec9dd8b2915c/displayicon.png'
	},
	{
		name: 'Gaia\'s Vengeance Ghost',
		price: 1275,
		rarity: 'Premium',
		image: 'https://media.valorant-api.com/weaponskinlevels/785897e9-4e78-024a-9db6-32906e3aca89/displayicon.png'
	}
];
---

<section class="store-grid-container">
	<div class="grid-header">
		<h2>Ofertas Diarias</h2>
		<div class="timer">
			<span class="label">Termina en:</span>
			<span class="time accent-text" id="store-timer">14:23:45</span>
		</div>
	</div>
	
	<div class="grid" id="skin-grid">
		{dailySkins.map(skin => (
			<SkinCard {...skin} />
		))}
	</div>

	<div id="auth-status" class="status-msg hide">
		<p>Sincronizado con tu cuenta real.</p>
	</div>
</section>

<style>
	/* ... existing styles ... */
	.store-grid-container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 2rem;
	}

	.grid-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1.5rem;
	}

	h2 {
		margin: 0;
		font-size: 1.5rem;
	}

	.timer {
		display: flex;
		align-items: center;
		gap: 10px;
		font-weight: 700;
	}

	.label {
		text-transform: uppercase;
		font-size: 0.8rem;
		opacity: 0.6;
	}

	.time {
		font-size: 1.2rem;
		font-variant-numeric: tabular-nums;
	}

	.grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
		gap: 1.5rem;
	}

	.status-msg {
		margin-top: 1rem;
		text-align: center;
		font-size: 0.8rem;
		opacity: 0.5;
	}

	.hide { display: none; }

	@media (max-width: 768px) {
		.grid {
			grid-template-columns: repeat(2, 1fr);
		}
	}

	@media (max-width: 480px) {
		.grid {
			grid-template-columns: 1fr;
		}
	}
</style>

<script>
	import { getPlayerStorefront, getSkinsDetails } from '../lib/valorant.js';

	const grid = document.getElementById('skin-grid');
	const timerEl = document.getElementById('store-timer');
	const statusEl = document.getElementById('auth-status');

	async function updateStore() {
		const auth = JSON.parse(localStorage.getItem('val_auth') || 'null');
		if (!auth || !auth.bearer || !auth.entitlements) return;

		try {
			statusEl.classList.remove('hide');
			statusEl.innerHTML = '<p class="accent-text">Sincronizando tienda real...</p>';
			
			const store = await getPlayerStorefront(auth.shard, auth.puuid, auth.bearer, auth.entitlements);
			const offerUuids = store.SkinsPanelLayout.SingleItemOffers;
			const remainingSeconds = store.SkinsPanelLayout.SingleItemOffersRemainingDurationInSeconds;
			
			// Update timer
			updateTimer(remainingSeconds);

			// Fetch skin details
			const skins = await getSkinsDetails(offerUuids);
			
			// Render real skins
			renderSkins(skins);
			
			statusEl.innerHTML = `<p>Sincronizado con la cuenta ${auth.puuid.substring(0, 8)}... (${auth.shard.toUpperCase()})</p>`;
		} catch (err) {
			console.error(err);
			statusEl.innerHTML = `<p class="accent-text">Error al sincronizar: ${err.message}</p>`;
		}
	}

	function renderSkins(skins) {
		grid.innerHTML = skins.map(skin => `
			<div class="skin-card glass animate-fade-in" style="--rarity-color: ${getRarityColor(skin.rarity)}">
				<div class="rarity-bar" style="background-color: ${getRarityColor(skin.rarity)}; box-shadow: 0 0 10px ${getRarityColor(skin.rarity)}"></div>
				<div class="image-container" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 1rem; position: relative;">
					<img src="${skin.image}" alt="${skin.name}" style="max-width: 90%; max-height: 80%; object-fit: contain; filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5)); transition: transform 0.5s ease;" />
				</div>
				<div class="info" style="padding: 1rem; background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%); display: flex; justify-content: space-between; align-items: flex-end;">
					<h3 class="name" style="margin: 0; font-size: 0.9rem; max-width: 70%; line-height: 1.2; color: white;">${skin.name}</h3>
					<div class="price-tag" style="display: flex; align-items: center; gap: 4px; font-weight: 700; font-size: 1rem;">
						<img src="https://media.valorant-api.com/currencies/85ad13f7-3d1b-5128-9eb2-7cd8ee0b1c89/displayicon.png" alt="VP" style="width: 18px; height: 18px;" />
						<span>1775</span>
					</div>
				</div>
			</div>
		`).join('');
	}

	function getRarityColor(rarity) {
		const colors = {
			Select: '#00ccff',
			Deluxe: '#00ff99',
			Premium: '#d151ff',
			Ultra: '#f9994c',
			Exclusive: '#ff4655',
		};
		return colors[rarity] || '#ffffff';
	}

	function updateTimer(seconds) {
		const h = Math.floor(seconds / 3600);
		const m = Math.floor((seconds % 3600) / 60);
		const s = seconds % 60;
		timerEl.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
	}

	// Listen for auth updates
	window.addEventListener('auth-updated', updateStore);
	
	// Initial load
	updateStore();
</script>
