---
---

<div class="auth-container glass animate-fade-in" id="auth-form-container">
	<div class="auth-header">
		<h3 id="form-title">Iniciar Sesión</h3>
		<p id="form-subtitle">Usa tus credenciales de Riot Games.</p>
	</div>
	
	<!-- Principal Login Form -->
	<form id="login-form">
		<div class="input-group">
			<label for="username">Nombre de Usuario</label>
			<input type="text" id="username" placeholder="Tu usuario..." required />
		</div>

		<div class="input-group">
			<label for="password">Contraseña</label>
			<input type="password" id="password" placeholder="••••••••" required />
		</div>

		<div class="input-group">
			<label for="shard">Región</label>
			<select id="shard" required>
				<option value="euw">EU (Europa)</option>
				<option value="na">NA (Norteamérica)</option>
				<option value="ap">AP (Asia-Pacífico)</option>
				<option value="kr">KR (Corea)</option>
				<option value="br">BR (Brasil)</option>
				<option value="latam">LATAM (Latinoamérica)</option>
			</select>
		</div>

		<div class="actions">
			<button type="submit" class="btn-primary" id="login-submit">Entrar</button>
		</div>
	</form>

	<!-- MFA Form (Hidden by default) -->
	<form id="mfa-form" class="hide">
		<div class="input-group">
			<label for="mfa-code">Código de Email (2FA)</label>
			<input type="text" id="mfa-code" placeholder="Código de 6 dígitos..." maxlength="6" />
		</div>
		<div class="actions">
			<button type="submit" class="btn-primary">Verificar Código</button>
			<button type="button" id="back-to-login" class="btn-secondary">Volver</button>
		</div>
	</form>

	<div id="auth-loading" class="hide">
		<p class="accent-text">Procesando...</p>
	</div>

	<div class="help-text">
		<p>Tus datos se envían directamente a Riot. No guardamos tu contraseña.</p>
	</div>
</div>

<style>
	.auth-container {
		max-width: 450px;
		margin: 2rem auto;
		padding: 2.5rem;
	}

	.auth-header {
		margin-bottom: 2rem;
		text-align: center;
	}

	.auth-header h3 {
		margin: 0;
		font-size: 1.5rem;
		color: var(--val-white);
	}

	.auth-header p {
		opacity: 0.6;
		font-size: 0.9rem;
		margin-top: 0.5rem;
	}

	.input-group {
		margin-bottom: 1.5rem;
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	label {
		font-size: 0.75rem;
		text-transform: uppercase;
		font-weight: 900;
		opacity: 0.5;
		letter-spacing: 1px;
	}

	select, input {
		background: rgba(0, 0, 0, 0.4);
		border: 1px solid var(--val-border);
		border-radius: 4px;
		padding: 1rem;
		color: var(--val-white);
		font-family: inherit;
		width: 100%;
		font-size: 1rem;
		transition: all 0.3s;
	}

	select:focus, input:focus {
		outline: none;
		border-color: var(--val-red);
		box-shadow: 0 0 15px rgba(255, 70, 85, 0.2);
		background: rgba(0, 0, 0, 0.6);
	}

	.actions {
		display: flex;
		gap: 1rem;
		margin-top: 2rem;
	}

	button {
		flex: 1;
		padding: 1.2rem;
		border-radius: 2px;
		font-weight: 900;
		text-transform: uppercase;
		cursor: pointer;
		transition: all 0.3s;
		font-family: inherit;
		letter-spacing: 2px;
	}

	.btn-primary {
		background: var(--val-red);
		color: white;
		border: none;
		position: relative;
		overflow: hidden;
	}

	.btn-primary:hover {
		background: #ff5e6a;
		transform: translateY(-2px);
		box-shadow: 0 5px 20px rgba(255, 70, 85, 0.4);
	}

	.btn-secondary {
		background: transparent;
		color: var(--val-white);
		border: 1px solid var(--val-border);
	}

	.btn-secondary:hover {
		background: rgba(255, 255, 255, 0.05);
	}

	#auth-loading {
		text-align: center;
		margin-top: 1rem;
		font-weight: 700;
		letter-spacing: 2px;
		text-transform: uppercase;
	}

	.hide { display: none !important; }

	.help-text {
		margin-top: 2rem;
		text-align: center;
		font-size: 0.75rem;
		opacity: 0.4;
		line-height: 1.4;
	}
</style>

<script>
	import { loginToRiot, submitMfaCode, parseAuthParams, getEntitlementsToken, getPuuidFromToken } from '../lib/valorant.js';

	const loginForm = document.getElementById('login-form');
	const mfaForm = document.getElementById('mfa-form');
	const loading = document.getElementById('auth-loading');
	const title = document.getElementById('form-title');
	const subtitle = document.getElementById('form-subtitle');
	const backBtn = document.getElementById('back-to-login');

	let currentShard = 'euw';

	loginForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const user = document.getElementById('username').value;
		const pass = document.getElementById('password').value;
		currentShard = document.getElementById('shard').value;

		setLoading(true);

		try {
			const result = await loginToRiot(user, pass);
			handleAuthResult(result);
		} catch (err) {
			alert('Error de conexión: ' + err.message);
			setLoading(false);
		}
	});

	mfaForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const code = document.getElementById('mfa-code').value;
		setLoading(true);

		try {
			const result = await submitMfaCode(code);
			handleAuthResult(result);
		} catch (err) {
			alert('Error MFA: ' + err.message);
			setLoading(false);
		}
	});

	backBtn.addEventListener('click', () => {
		mfaForm.classList.add('hide');
		loginForm.classList.remove('hide');
		title.textContent = 'Iniciar Sesión';
		subtitle.textContent = 'Usa tus credenciales de Riot Games.';
	});

	async function handleAuthResult(result) {
		console.log('RSO Result:', result);

		if (result.error === 'auth_failure') {
			alert('Usuario o contraseña incorrectos.');
			setLoading(false);
			return;
		}

		if (result.type === 'mfa') {
			loginForm.classList.add('hide');
			mfaForm.classList.remove('hide');
			title.textContent = 'Verificación Requerida';
			subtitle.textContent = `Introduce el código enviado a ${result.mfa.email}.`;
			setLoading(false);
			return;
		}

		if (result.response && result.response.parameters && result.response.parameters.uri) {
			try {
				const { accessToken } = parseAuthParams(result.response.parameters.uri);
				const entitlements = await getEntitlementsToken(accessToken);
				const puuid = getPuuidFromToken(accessToken);

				// Save to localStorage
				localStorage.setItem('val_auth', JSON.stringify({
					shard: currentShard,
					puuid: puuid,
					bearer: accessToken,
					entitlements: entitlements
				}));

				window.dispatchEvent(new CustomEvent('auth-updated'));
				setLoading(false);
				alert('¡Sesión iniciada correctamente!');
				
				// Close form (optional, could be handled by parent)
				document.getElementById('auth-section').classList.add('hide');
			} catch (err) {
				alert('Error al obtener tokens finales: ' + err.message);
				setLoading(false);
			}
		} else {
			alert('Error inesperado en la respuesta de Riot.');
			setLoading(false);
		}
	}

	function setLoading(isLoading) {
		loading.classList.toggle('hide', !isLoading);
		loginForm.style.opacity = isLoading ? '0.3' : '1';
		loginForm.style.pointerEvents = isLoading ? 'none' : 'auto';
		mfaForm.style.opacity = isLoading ? '0.3' : '1';
		mfaForm.style.pointerEvents = isLoading ? 'none' : 'auto';
	}
</script>
